{% comment %}
Renders a single publication card.
Requires: pub (publication object), index (forloop.index), total_count (total pubs)
{% endcomment %}

{% assign pub = include.pub %}

<div class="card shadow-sm h-100 border-0" style="background-color: var(--bs-card-bg);">
    <div class="card-body p-4 d-flex flex-column">

        {% comment %} --- TOP SECTION: Metadata Tags and Type Badge --- {% endcomment %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="badge rounded-pill text-bg-secondary me-1 fw-normal text-uppercase small">{{ pub.type }}</span>
            <small class="text-muted fw-bold">
                #{{ include.index }} / {{ include.total_count }}
            </small>
        </div>

        {% comment %} --- MIDDLE SECTION: Title and Details --- {% endcomment %}
        <div class="flex-grow-1">
            <h5 class="fw-bold mb-2">
                <a href="/publications/#{{ pub.id }}" class="text-primary text-decoration-none">
                    {{ pub.title }}
                </a>
            </h5>
            <p class="small text-muted mb-2">
                {{ pub.authors }}
                {% if pub.year %}
                <br><span class="fw-bold">{{ pub.year }}</span> in {{ pub.source_info }}
                {% endif %}
            </p>
        </div>

        {% comment %} --- BOTTOM SECTION: Actions (Abstract, DOI, Copy) --- {% endcomment %}
        <div class="mt-3">
            {% if pub.abstract %}
            <button class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#abstractModal{{ pub.id }}">
                Abstract
            </button>
            {% endif %}

            {% if pub.doi %}
            <a href="https://doi.org/{{ pub.doi }}" class="btn btn-sm btn-outline-primary me-2" target="_blank" rel="noopener noreferrer">
                DOI
            </a>
            {% endif %}

            {% comment %}
            --- THIS IS THE FIX ---
            - The 'onclick' attribute now calls 'generateAndCopyBibtex(this)'.
            - 'data-*' attributes are added to hold the publication data.
            - The old hidden <div> is completely removed.
            {% endcomment %}
            <button class="btn btn-sm btn-outline-primary"
                    onclick="generateAndCopyBibtex(this)"
                    data-type="{{ pub.type | default: 'article' | downcase }}"
                    data-id="{{ pub.id | default: pub.title | slugify }}"
                    data-title="{{ pub.title | escape }}"
                    data-authors="{{ pub.authors | escape }}"
                    data-year="{{ pub.year | escape }}"
                    data-source="{{ pub.source_info | escape }}">
                <i class="fas fa-copy me-1"></i> Copy BibTeX
            </button>
        </div>
        </div>
    </div>

    {% comment %} --- MODAL FOR ABSTRACT --- {% endcomment %}
    {% if pub.abstract %}
    <div class="modal fade" id="abstractModal{{ pub.id }}" tabindex="-1" aria-labelledby="abstractModalLabel{{ pub.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" style="background-color: var(--bs-body-bg);">
                <div class="modal-header">
                    <h5 class="modal-title" id="abstractModalLabel{{ pub.id }}">{{ pub.title }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-3">{{ pub.authors }} ({{ pub.year }})</p>
                    <p>{{ pub.abstract | markdownify }}</p>
                    <p class="text-muted mt-3 small">Source: {{ pub.source_info }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}