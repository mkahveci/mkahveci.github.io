<div class="container my-5">

    <div class="text-center mb-5">
        <p class="lead col-lg-8 mx-auto">
            A log of personal trade ideas based on market analysis, focusing on options premium selling strategies. This is for educational and entertainment purposes only.
        </p>
    </div>

    {% comment %} --- 1. DATA PREPARATION --- {% endcomment %}
    {% assign sorted_trades = site.data.trade_ideas | default: [] %}

    {% assign strategies_new = sorted_trades | map: 'strategyDetails' | map: 'type' | compact %}
    {% assign strategies_old = sorted_trades | map: 'analysis' | map: 'strategyType' | compact %}
    {% assign all_strategies = strategies_new | concat: strategies_old | uniq | sort %}

    <section id="dashboard" class="mb-5">
        <h2 class="display-6 mb-4"><i class="fas fa-tachometer-alt fa-fw text-muted me-2"></i> Performance Dashboard</h2>

        <div class="d-flex justify-content-end mb-3" style="gap: 0.5rem;">
            <div class="d-flex align-items-center" style="gap: 0.5rem;">
                <label for="unified-filter" class="form-label small text-muted mb-0">Filter By:</label>
                <select id="unified-filter" class="form-select form-select-sm d-inline-block w-auto">
                    <option value="all" selected>All Trades & Periods</option>
                    <optgroup label="Position Status">
                        <option value="position-open">Open Positions Only</option>
                        <option value="position-closed">Closed Positions Only</option>
                    </optgroup>
                    <optgroup label="Trading Strategy">
                        {% for strategy in all_strategies %}
                        <option value="strategy-{{ strategy | slugify }}">{{ strategy }}</option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="Time Period">
                        <option value="period-{{ site.time | date: '%Y' }}">This Year ({{ site.time | date: '%Y' }})</option>
                        <option value="period-{{ site.time | date: '%Y' | minus: 1 }}">Last Year ({{ site.time | date: '%Y' | minus: 1 }})</option>
                        <option value="period-all-time">All Periods</option>
                    </optgroup>
                </select>
            </div>
            <div class="d-flex align-items-center" style="gap: 0.5rem;">
                <label for="dash-account-filter" class="form-label small text-muted mb-0">Account:</label>
                <select id="dash-account-filter" class="form-select form-select-sm d-inline-block w-auto">
                    <option value="all" selected>All Accounts</option>
                    <option value="margin">Margin</option>
                    <option value="ira">IRA</option>
                    <option value="paper">Paper</option>
                </select>
            </div>
        </div>

        {% comment %} --- KPI DASHBOARD (Requires JS to populate) --- {% endcomment %}
        <div class="row g-3" id="kpi-container">
            <div class="col-md-3 col-6"><div class="p-2 rounded bg-body-tertiary shadow-sm h-100 text-center"><h6 class="card-subtitle mb-1 small text-body fw-bold">Total P/L</h6><h6 class="card-title mb-0" id="kpi-total-pnl">$0.00</h6></div></div>
            <div class="col-md-3 col-6"><div class="p-2 rounded bg-body-tertiary shadow-sm h-100 text-center"><h6 class="card-subtitle mb-1 small text-body fw-bold">Win Rate</h6><h6 class="card-title mb-0" id="kpi-win-rate">0%</h6></div></div>
            <div class="col-md-3 col-6"><div class="p-2 rounded bg-body-tertiary shadow-sm h-100 text-center"><h6 class="card-subtitle mb-1 small text-body fw-bold">Avg. Profit</h6><h6 class="card-title mb-0" id="kpi-avg-profit">$0.00</h6></div></div>
            <div class="col-md-3 col-6"><div class="p-2 rounded bg-body-tertiary shadow-sm h-100 text-center"><h6 class="card-subtitle mb-1 small text-body fw-bold">Avg. Loss</h6><h6 class="card-title mb-0" id="kpi-avg-loss">$0.00</h6></div></div>
        </div>
    </section>

    <section id="trades">
        <h2 class="display-6 mb-4 mt-5"><i class="fas fa-chart-line fa-fw text-muted me-2"></i> Options Trading Log</h2>

        <div class="row row-cols-1 g-4">
            {% assign current_count = 0 %}

            {% for trade in sorted_trades %}

            {% comment %} --- NORMALIZATION LAYER --- {% endcomment %}

            {% comment %} 1. Meta Data {% endcomment %}
            {% assign t_title = trade.meta.tradeTitle | default: trade.tradeTitle %}
            {% assign t_date  = trade.meta.publicationDate | default: trade.publicationDate %}
            {% assign t_account = trade.meta.accountType | default: trade.accountType | default: 'Margin' %}
            {% assign t_ticker = trade.meta.ticker | default: trade.ticker %}

            {% comment %} 2. Market Context {% endcomment %}
            {% assign t_price = trade.marketContext.currentPrice | default: trade.currentPrice %}
            {% assign t_iv = trade.marketContext.ivRank | default: trade.ivRank %}
            {% assign t_earnings = trade.marketContext.earningsDate | default: trade.earningsDate %}
            {% assign t_thesis = trade.marketContext.thesis | default: trade.analysis.thesis %}
            {% assign t_plan = trade.managementPlan.notes | default: trade.analysis.managementPlan %}

            {% comment %} 3. Strategy Details {% endcomment %}
            {% assign t_strat_type = trade.strategyDetails.type | default: trade.analysis.strategyType %}
            {% assign t_expiration = trade.strategyDetails.expirationDate | default: trade.analysis.tradeDetails.expiration %}
            {% assign t_dte = trade.strategyDetails.dte | default: trade.analysis.tradeDetails.dte %}
            {% assign t_legs = trade.strategyDetails.legs %}
            {% assign t_spread_details = trade.analysis.tradeDetails.spreadDetails %}

            {% comment %} 4. Financials {% endcomment %}
            {% assign t_max_profit = trade.financials.maxProfit | default: trade.analysis.tradeDetails.maxProfit %}
            {% assign t_roc = trade.financials.metrics.roc | default: trade.analysis.metrics.roc %}
            {% assign t_pop = trade.financials.metrics.pop | default: trade.analysis.metrics.pop %}
            {% assign t_bp = trade.financials.buyingPowerEffect | default: trade.analysis.metrics.buyingPowerEffect %}
            {% assign t_entry_price = trade.financials.entryPrice | default: t_spread_details.netCredit %}

            {% comment %} 5. Status Logic {% endcomment %}
            {% assign last_step = trade.tradeProgression | last %}
            {% if last_step.stepType == 'CLOSE_TRADE' or last_step.stepType == 'CLOSE' or last_step.stepType == 'CALLED_AWAY' or last_step.stepType == 'CLOSED_INDEPENDENT_PUT' %}
            {% assign trade_status_slug = "closed" %}
            {% else %}
            {% assign trade_status_slug = "open" %}
            {% endif %}

            {% assign account_lower = t_account | downcase %}
            {% assign trade_strategy_slug = t_strat_type | slugify | default: 'unknown' %}
            {% assign trade_year = t_date | date: "%Y" %}


            <div class="col trade-card-wrapper"
                 data-account-type="{{ account_lower }}"
                 data-position="{{ trade_status_slug }}"
                 data-strategy="{{ trade_strategy_slug }}"
                 data-year="{{ trade_year }}">

                <div class="card h-100 shadow-sm border-0 d-flex">
                    <div class="card-body d-flex">

                        <div class="date-block me-3">
                            <span class="month">{{ t_date | date: "%b" | upcase }}</span>
                            <span class="day">{{ t_date | date: "%d" }}</span>
                        </div>

                        <div class="flex-grow-1">

                            <div class="trade-card-header d-flex justify-content-between align-items-start" style="gap: 0.5rem;">
                                <h5 class="card-title h6 mb-1">{{ t_title }}</h5>

                                <div class="d-flex flex-shrink-0" style="gap: 0.5rem;">
                                    {% if trade_status_slug == "open" %}
                                    <span class="status-pill status-open">Open</span>
                                    {% else %}
                                    <span class="status-pill status-closed">Closed</span>
                                    {% endif %}
                                    <span class="status-pill account-{{ account_lower }}">{{ t_account }}</span>
                                </div>
                            </div>

                            {% if trade.meta.tags %}
                            <div class="mb-2">
                                {% for tag in trade.meta.tags limit:2 %}
                                <span class="badge text-bg-light fw-normal text-secondary border me-1">{{ tag }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <div class="d-flex justify-content-between small p-2 rounded bg-tertiary-subtle mt-2">
                                <span>Price: <strong>{% unless t_ticker contains '/' %}&#36;{% endunless %}{{ t_price | round: 2 }}</strong></span>
                                <span>IV Rank: <strong>{{ t_iv }}%</strong></span>
                                <span>Earnings: <strong>{{ t_earnings | default: "N/A" }}</strong></span>
                            </div>

                            <p class="card-text small mt-3">{{ t_thesis | truncatewords: 30 }}</p>

                            <div class="trade-card-section bg-tertiary-subtle">
                                <ul class="list-unstyled small mb-0">
                                    <li class="d-flex justify-content-between"><span><strong>Strategy:</strong></span><span class="font-monospace">{{ t_strat_type }}</span></li>
                                    <li class="d-flex justify-content-between pt-1"><span><strong>Expiration (DTE):</strong></span><span class="font-monospace">{{ t_expiration | date: "%b %d, %Y" }} ({{ t_dte }})</span></li>
                                    <li class="d-flex justify-content-between pt-1"><span><strong>Entry Price:</strong></span><span class="font-monospace text-primary">{% unless t_ticker contains '/' %}&#36;{% endunless %}{{ t_entry_price }}</span></li>
                                    {% comment %} Max Profit/BP are usually hard dollars, so we keep the $ sign here {% endcomment %}
                                    <li class="d-flex justify-content-between pt-1"><span><strong>Max Profit:</strong></span><span class="font-monospace text-success">&#36;{{ t_max_profit }}</span></li>
                                </ul>

                                <h6 class="small mt-3 mb-1"><strong>Leg Details</strong></h6>
                                <div class="leg-grid">
                                    {% if t_legs %}
                                    {% for leg in t_legs %}
                                    <div class="leg-item">
                                        <strong class="{% if leg.action == 'Sell' %}text-danger{% else %}text-success{% endif %}">{{ leg.action | upcase }} {{ leg.type | upcase }}</strong>
                                        <span>{% unless t_ticker contains '/' %}&#36;{% endunless %}{{ leg.strike }}</span>
                                        <span class="text-muted small" style="font-size: 0.7em;">{{ leg.expiry | date: "%b %d" }}</span>
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    {% comment %} OLD JSON FORMAT FALLBACK {% endcomment %}
                                    {% if t_spread_details.shortPutStrike > 0 %}
                                    <div class="leg-item"><strong>SELL PUT</strong><span class="text-danger">{% unless t_ticker contains '/' %}&#36;{% endunless %}{{ t_spread_details.shortPutStrike }}</span></div>
                                    {% endif %}
                                    {% if t_spread_details.longPutStrike > 0 %}
                                    <div class="leg-item"><strong>BUY PUT</strong><span class="text-success">{% unless t_ticker contains '/' %}&#36;{% endunless %}{{ t_spread_details.longPutStrike }}</span></div>
                                    {% endif %}
                                    {% if t_spread_details.shortCallStrike > 0 %}
                                    <div class="leg-item"><strong>SELL CALL</strong><span class="text-danger">{% unless t_ticker contains '/' %}&#36;{% endunless %}{{ t_spread_details.shortCallStrike }}</span></div>
                                    {% endif %}
                                    {% if t_spread_details.longCallStrike > 0 %}
                                    <div class="leg-item"><strong>BUY CALL</strong><span class="text-success">{% unless t_ticker contains '/' %}&#36;{% endunless %}{{ t_spread_details.longCallStrike }}</span></div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>

                            <div class="trade-card-section bg-info-subtle">
                                <div class="metrics-grid">
                                    <div class="metric-item text-center"><strong>ROC</strong><span>{{ t_roc | round: 1 }}%</span></div>
                                    <div class="metric-item text-center"><strong>POP</strong><span>{{ t_pop | round: 0 }}%</span></div>
                                    <div class="metric-item text-center"><strong>Buying Power</strong><span>&#36;{{ t_bp | round: 0 }}</span></div>
                                </div>
                            </div>

                            <div class="trade-progression-container small">
                                <h6 class="h6 small"><strong>Trade Progression Log</strong></h6>
                                {% if trade.tradeProgression and trade.tradeProgression.size > 0 %}
                                <ol class="progression-timeline">
                                    {% for step in trade.tradeProgression %}
                                    {% assign step_type_lower = step.stepType | downcase %}
                                    {% assign step_class = step_type_lower | replace: ': ', '-' | replace: ':', '-' | replace: '_', '-' %}

                                    <li class="progression-step step-{{ step_class }}">
                                        <div class="progression-header">
                                            {% assign original_text = step.stepType | replace: '_', ' ' %}
                                            {% assign pill_text = original_text | capitalize %}
                                            {% assign action_category = "default" %}

                                            {% if step.stepType contains 'OPEN' %} {% assign action_category = "open" %}
                                            {% elsif step.stepType contains 'CLOSE' %} {% assign action_category = "close" %}
                                            {% elsif step.stepType contains 'ADJUST' or step.stepType contains 'ROLL' %} {% assign action_category = "adjust" %}
                                            {% endif %}

                                            <span class="progression-tag tag-{{ action_category }}">{{ pill_text }}</span>
                                            <span class="progression-date">{{ step.date | date: "%b %d" }}</span>
                                        </div>
                                        <div class="progression-details">
                                            {% if step.action or step.actionTaken %}
                                            <p class="mb-1"><strong>Action:</strong> {{ step.action | default: step.actionTaken }}</p>
                                            {% endif %}

                                            {% comment %} Financials Check {% endcomment %}
                                            {% assign pnl = step.financials.netPnl | default: step.grossProfitLossAmount %}
                                            {% if pnl %}
                                            <span class="profit-loss {% if pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                    (P/L: {% if pnl >= 0 %}+{% endif %}&#36;{{ pnl | round: 2 }})
                                                </span>
                                            {% endif %}

                                            {% if step.notes %}
                                            <div class="bg-warning-subtle p-2 small mt-1 mb-0 border-0">
                                                {{ step.notes | markdownify | strip_newlines }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ol>
                                {% endif %}
                            </div>

                        </div>
                    </div>

                    <div class="card-footer bg-body-tertiary">
                        <div class="d-flex flex-wrap justify-content-end" style="gap: 0.5rem;">
                            {% assign search_term = t_ticker | append: " stock" %}
                            {% if t_title contains "Futures" or t_ticker contains "/" %}{% assign search_term = t_ticker | append: " site:cmegroup.com" %}{% endif %}

                            <a href="https://www.google.com/search?q={{ search_term | url_encode }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-chart-line fa-fw me-1"></i> Chart</a>
                            <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ current_count }}"><i class="fas fa-info-circle fa-fw me-1"></i> Plan</button>
                            <button onclick="copyTradeDetails(this)" class="btn btn-sm btn-outline-secondary" title="Copy"><i class="fas fa-copy fa-fw me-1"></i> Copy</button>

                            <div class="trade-details-data" style="display: none;">
                                Trade: {{ t_title }} | Strategy: {{ t_strat_type }} | Max Profit: &#36;{{ t_max_profit }}
                            </div>
                        </div>
                        <div class="collapse mt-3" id="collapse-{{ current_count }}">
                            <div class="small p-3 rounded bg-warning-subtle">
                                <h6 class="h6 small"><strong>Management Plan</strong></h6>
                                <p class="mb-0">{{ t_plan | default: "No plan recorded." }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% assign current_count = current_count | plus: 1 %}
            {% endfor %}
        </div>
    </section>
</div>

<script>
    // --- JS LOGIC FOR FILTERS & KPIS ---
    const jekyllData = {{ site.data.trade_ideas | jsonify }};

    document.addEventListener('DOMContentLoaded', function() {
        let closedTradesData = [];
        const unifiedFilter = document.getElementById('unified-filter');
        const accountFilter = document.getElementById('dash-account-filter');
        const tradeCards = document.querySelectorAll('.trade-card-wrapper');

        // Definition of a "Closed" status based on the final step
        const CLOSED_STEPS = ['CLOSE_TRADE', 'CLOSE', 'CALLED_AWAY', 'CLOSED_INDEPENDENT_PUT'];

        function loadAndProcessData() {
            try {
                if (!jekyllData) return;

                jekyllData.forEach(trade => {
                    if (!trade.tradeProgression || trade.tradeProgression.length === 0) return;

                    // 1. Determine Trade Status
                    const lastStep = trade.tradeProgression[trade.tradeProgression.length - 1];
                    const lastStepType = (lastStep.stepType || "").toUpperCase();

                    // Only process CLOSED trades
                    if (CLOSED_STEPS.includes(lastStepType)) {

                        // 2. Calculate Total Trade P/L
                        let tradeTotalPnl = 0;
                        trade.tradeProgression.forEach(step => {
                            const stepType = (step.stepType || "").toUpperCase();

                            // --- CRITICAL FIX: IGNORE "OPEN" STEPS ---
                            // Opening a trade (Debit or Credit) is not a Realized P/L event.
                            // This prevents debit paid (-$245) from counting as a Loss.
                            if (stepType.startsWith('OPEN')) return;

                            let stepPnl = 0;
                            // Handle schema variations
                            if (step.financials && step.financials.netPnl !== undefined) {
                                stepPnl = parseFloat(step.financials.netPnl);
                            } else if (step.grossProfitLossAmount !== undefined) {
                                stepPnl = parseFloat(step.grossProfitLossAmount);
                            }

                            if (!isNaN(stepPnl)) {
                                tradeTotalPnl += stepPnl;
                            }
                        });

                        // 3. Extract Meta for Filtering
                        const meta = trade.meta || {};
                        const account = (meta.accountType || trade.accountType || 'margin').toLowerCase();
                        const analysis = trade.strategyDetails || trade.analysis || {};
                        const strategy = (analysis.type || analysis.strategyType || 'unknown').toLowerCase().replace(/[^a-z0-9]/g, '-');

                        // Use the CLOSE DATE for time-period filtering
                        const closeDate = new Date(lastStep.date);
                        const closeYear = closeDate.getFullYear().toString();

                        // 4. Push to Data Array
                        closedTradesData.push({
                            pnl: tradeTotalPnl,
                            account: account,
                            strategy: strategy,
                            year: closeYear,
                            status: 'closed'
                        });
                    }
                });

                updateDashboardAndLog();
            } catch (error) { console.error('Error processing trade data:', error); }
        }

        function updateDashboardAndLog() {
            const selectedAccount = accountFilter.value;
            const unifiedFilterValue = unifiedFilter.value;

            // --- 1. Filter Metrics Data ---
            let metricsSource = closedTradesData;

            if (selectedAccount !== 'all') {
                metricsSource = metricsSource.filter(t => t.account === selectedAccount);
            }

            if (unifiedFilterValue !== 'all') {
                if (unifiedFilterValue.startsWith('strategy-')) {
                    const strat = unifiedFilterValue.replace('strategy-', '');
                    metricsSource = metricsSource.filter(t => t.strategy === strat);
                } else if (unifiedFilterValue.startsWith('period-')) {
                    const period = unifiedFilterValue.replace('period-', '');
                    if (period !== 'all-time') {
                        metricsSource = metricsSource.filter(t => t.year === period);
                    }
                } else if (unifiedFilterValue === 'position-open') {
                    metricsSource = [];
                }
            }

            updateKPIs(metricsSource);

            // --- 2. Filter Trade Cards ---
            tradeCards.forEach((card) => {
                const cardAccount = card.dataset.accountType;
                const cardStrat = card.dataset.strategy;
                const cardYear = card.dataset.year;
                const cardPos = card.dataset.position;

                const accMatch = (selectedAccount === 'all' || cardAccount === selectedAccount);
                let unifiedMatch = true;

                if (unifiedFilterValue !== 'all') {
                    if (unifiedFilterValue.startsWith('position-')) {
                        unifiedMatch = (cardPos === unifiedFilterValue.replace('position-', ''));
                    } else if (unifiedFilterValue.startsWith('strategy-')) {
                        unifiedMatch = (cardStrat === unifiedFilterValue.replace('strategy-', ''));
                    } else if (unifiedFilterValue.startsWith('period-')) {
                         const pVal = unifiedFilterValue.replace('period-', '');
                         if(pVal !== 'all-time') unifiedMatch = (cardYear === pVal);
                    }
                }

                card.style.display = (accMatch && unifiedMatch) ? 'block' : 'none';
            });
        }

        function updateKPIs(data) {
            let totalPnl = 0; let winners = 0; let losers = 0;
            let totalProfit = 0; let totalLoss = 0;

            data.forEach(t => {
                const pnl = t.pnl;
                totalPnl += pnl;
                if (pnl > 0) {
                    winners++;
                    totalProfit += pnl;
                } else if (pnl < 0) {
                    losers++;
                    totalLoss += pnl;
                }
            });

            const totalTrades = winners + losers;
            const winRate = totalTrades > 0 ? (winners / totalTrades) * 100 : 0;
            const avgProfit = winners > 0 ? totalProfit / winners : 0;
            const avgLoss = losers > 0 ? totalLoss / losers : 0;

            const pnlEl = document.getElementById('kpi-total-pnl');
            pnlEl.textContent = '$' + totalPnl.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            pnlEl.className = `card-title mb-0 ${totalPnl >= 0 ? 'text-success' : 'text-danger'}`;

            document.getElementById('kpi-win-rate').textContent = winRate.toFixed(1) + '%';

            const avgProfitEl = document.getElementById('kpi-avg-profit');
            avgProfitEl.textContent = '$' + avgProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            avgProfitEl.className = 'card-title mb-0 text-success';

            const avgLossEl = document.getElementById('kpi-avg-loss');
            avgLossEl.textContent = '$' + Math.abs(avgLoss).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            avgLossEl.className = 'card-title mb-0 text-danger';
        }

        unifiedFilter.addEventListener('change', updateDashboardAndLog);
        accountFilter.addEventListener('change', updateDashboardAndLog);
        loadAndProcessData();
    });

    function copyTradeDetails(button) {
      const detailsContainer = button.nextElementSibling;
      const detailsText = detailsContainer.textContent.trim().replace(/\s+/g, ' ');

      navigator.clipboard.writeText(detailsText).then(() => {
        const originalIcon = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check fa-fw me-1"></i> Copied!';
        button.classList.replace('btn-outline-secondary', 'btn-success');
        setTimeout(() => {
          button.innerHTML = originalIcon;
          button.classList.replace('btn-success', 'btn-outline-secondary');
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy text: ', err);
      });
    }
</script>