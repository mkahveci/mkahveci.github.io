<div style="height: 400px; max-width: 100%;">
    <canvas id="cumulativePnLChart"></canvas>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Load the data directly from the Jekyll site object
        const rawData = {{ site.data.performance_report.time_series_data.daily_net_pnl | jsonify }};

        if (rawData && rawData.length > 0) {
            // 2. Prepare the time-series data for the chart
            let cumulativePnl = 0;
            const chartData = rawData.map(item => {
                cumulativePnl += item.net_pnl_daily;
                return {
                    date: item.date,
                    pnl: cumulativePnl // This is the running total
                };
            }).filter(item => item.pnl !== 0 || item.date === rawData[0].date); // Filter out zero-P&L days unless it's the start

            const labels = chartData.map(item => item.date);
            const dataPoints = chartData.map(item => item.pnl.toFixed(2));

            // Get the starting point (if not explicitly $0)
            const startingValue = dataPoints[0] || 0;

            // 3. Configure and render the Chart.js graph
            const ctx = document.getElementById('cumulativePnLChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative Net P&L ($)',
                        data: dataPoints,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Cumulative P&L ($)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

        } else {
            document.getElementById('cumulativePnLChart').parentElement.innerHTML = "<p>No closed trade data available for charting yet.</p>";
        }
    });
</script>
